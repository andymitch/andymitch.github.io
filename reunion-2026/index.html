<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>2026 San Diego Reunion Options</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <!-- Data is loaded from local options.json via fetch() -->
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #222;
      background: #f6f7fb;
    }

    header {
      padding: 1rem 1.5rem;
      background: #1f2937;
      color: #f9fafb;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0 0 0.25rem 0;
      font-size: 1.4rem;
    }

    header p {
      margin: 0;
      font-size: 0.9rem;
      opacity: 0.85;
    }

    main {
      padding: 1rem 1.5rem 1.5rem;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      grid-gap: 1rem;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: #ffffff;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
      padding: 0.75rem 1rem 1rem;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .panel-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 0.5rem;
      gap: 0.5rem;
    }

    .panel-header h2 {
      font-size: 1rem;
      margin: 0;
    }

    .panel-header small {
      color: #6b7280;
    }

    #table-container {
      overflow: auto;
      max-height: 70vh;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 640px;
      font-size: 0.9rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #f3f4f6;
      z-index: 1;
    }

    th,
    td {
      padding: 0.5rem 0.6rem;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      color: #374151;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    th .sort-indicator {
      margin-left: 0.2rem;
      font-size: 0.75rem;
      opacity: 0.7;
    }

    tbody tr {
      background: #ffffff;
      transition: background 0.12s ease, box-shadow 0.12s ease;
      cursor: pointer;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    tbody tr:hover {
      background: #eef2ff;
    }

    tr.selected-row {
      background: #e0ecff !important;
      box-shadow: inset 2px 0 0 #2563eb;
    }

    td a {
      color: #2563eb;
      text-decoration: none;
      word-break: break-all;
    }

    td a:hover {
      text-decoration: underline;
    }

    #map {
      width: 100%;
      height: 70vh;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
    }

    .legend {
      font-size: 0.8rem;
      color: #4b5563;
      margin-bottom: 0.35rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>2026 San Diego Reunion — Lodging Options</h1>
    <p>Feb 13–17 · Total headcount 18 (10 adults, 6 kids, 2 infants)</p>
  </header>

  <main>
    <section class="panel" aria-label="Options table">
      <div class="panel-header">
        <h2>Options data table</h2>
        <small>Click a column header to sort. Click a row to highlight it on the map.</small>
      </div>
      <div id="table-container">
        <table id="options-table">
          <thead>
            <tr id="table-header-row"></tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </section>

    <section class="panel" aria-label="Map view">
      <div class="panel-header">
        <h2>Map view</h2>
        <small>Click a pin to highlight the matching row in the table.</small>
      </div>
      <div class="legend">
        Locations are approximate, based on neighborhood / city described in each listing.
      </div>
      <div id="map"></div>
    </section>
  </main>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // --- Configuration ------------------------------------------------------

    const DATA_JSON_PATH = 'options.json';

    // Approximate coordinates for each listing, keyed by Link URL.
    // These are neighborhood-level locations (Mission Bay, Sunset Cliffs, Oceanside, etc.).
    const LINK_TO_COORDS = {
      // Mission Bay / beach area (Vrbo)
      'https://t.vrbo.io/kuBwZwcpwYb': { lat: 32.780, lng: -117.240 },
      'https://t.vrbo.io/KmzeLbcnwYb': { lat: 32.782, lng: -117.245 },
      'https://t.vrbo.io/yKfPNM0mwYb': { lat: 32.776, lng: -117.230 },

      // Central San Diego / coastal neighborhoods (Airbnb)
      'https://www.airbnb.com/l/73JjAySD': { lat: 32.725, lng: -117.216 }, // Liberty Station
      'https://www.airbnb.com/l/gI5iguvt': { lat: 32.720, lng: -117.255 }, // Sunset Cliffs
      'https://www.airbnb.com/l/shNqYAjG': { lat: 32.723, lng: -117.223 }, // Point Loma (Rosecrans & Nimitz area)
      'https://www.airbnb.com/l/ExuS2CHd': { lat: 32.739, lng: -117.252 }, // South Ocean Beach
      'https://www.airbnb.com/l/VSAplHVo': { lat: 32.717, lng: -117.259 }, // Sunset Cliffs oceanfront
      'https://www.airbnb.com/l/3EFY0qEC': { lat: 32.789, lng: -117.201 }, // Bay Park

      // North County coastal (mainly Oceanside / Carlsbad)
      'https://www.airbnb.com/l/kaFJzZ7v': { lat: 33.197, lng: -117.382 }, // Oceanside
      'https://www.airbnb.com/l/oOFwzYUO': { lat: 33.195, lng: -117.379 }, // Oceanside
      'https://www.airbnb.com/l/cR9wooXz': { lat: 33.196, lng: -117.387 }, // Beachfront townhome
      'https://www.airbnb.com/l/R3xP4gUG': { lat: 33.198, lng: -117.390 }, // Beachfront house
      'https://www.airbnb.com/l/yKds1dcu': { lat: 33.199, lng: -117.384 }, // Huge beach house
      'https://www.airbnb.com/l/57WIGk2G': { lat: 33.144, lng: -117.329 }, // Carlsbad lagoon
      'https://www.airbnb.com/l/nKs2zfxe': { lat: 33.145, lng: -117.335 }, // Carlsbad oceanfront
      'https://www.airbnb.com/l/WiuAYYJe': { lat: 33.1955, lng: -117.381 }, // Wyndham Oceanside Resort

      // North County inland (Escondido / Vista)
      'https://www.airbnb.com/l/UaecaKgG': { lat: 33.124, lng: -117.090 }, // Escondido family retreat
      'https://www.airbnb.com/l/TrWJfyuo': { lat: 33.203, lng: -117.240 }, // Vista family home
      'https://www.airbnb.com/l/YYZeV19i': { lat: 33.205, lng: -117.235 }, // Vista pool home
      'https://www.airbnb.com/l/2uj1sDZH': { lat: 33.115, lng: -117.090 }, // Escondido resort home
      'https://www.airbnb.com/l/M7E5hVUs': { lat: 33.117, lng: -117.085 }  // Escondido large resort home
    };

    const COLUMN_CONFIG = [
      { key: 'quickDescription', label: 'Description' },
      { key: 'bedrooms', label: 'Bedrooms' },
      { key: 'bathrooms', label: 'Bathrooms' },
      { key: 'sqFt', label: 'Sq Ft' },
      { key: 'totalCost', label: 'Total cost' },
      { key: 'costPerCouple', label: 'Cost/couple' },
      { key: 'link', label: 'Link' }
    ];

    const COLUMNS_TO_DISPLAY = COLUMN_CONFIG.map((c) => c.key);

    // --- State ----------------------------------------------------------------

    let allRows = [];
    let currentSort = { column: null, direction: 'asc' };

    const rowIdToMarker = new Map();
    let map = null;
    let markersLayer = null;
    let selectedRowId = null;

    // --- Utility functions ----------------------------------------------------

    function normalizeCurrency(value) {
      if (value == null) return null;
      const cleaned = String(value).replace(/[^0-9.\-]/g, '');
      const num = parseFloat(cleaned);
      return Number.isNaN(num) ? null : num;
    }

    function normalizeNumber(value) {
      if (value == null || value === '') return null;
      if (typeof value === 'number') return value;
      const cleaned = String(value).replace(/[^0-9.\-]/g, '');
      const num = parseFloat(cleaned);
      return Number.isNaN(num) ? null : num;
    }

    function getSortValue(row, columnKey) {
      const value = row[columnKey];
      if (columnKey === 'totalCost' || columnKey === 'costPerCouple') {
        return normalizeCurrency(value);
      }
      if (columnKey === 'sqFt' || columnKey === 'bedrooms' || columnKey === 'bathrooms') {
        return normalizeNumber(value);
      }
      // default string sort
      return (value ?? '').toString().toLowerCase();
    }

    function compareRows(a, b, columnKey, direction) {
      const av = getSortValue(a, columnKey);
      const bv = getSortValue(b, columnKey);

      if (av == null && bv == null) return 0;
      if (av == null) return 1;
      if (bv == null) return -1;

      if (typeof av === 'number' && typeof bv === 'number') {
        return direction === 'asc' ? av - bv : bv - av;
      }

      if (av < bv) return direction === 'asc' ? -1 : 1;
      if (av > bv) return direction === 'asc' ? 1 : -1;
      return 0;
    }

    function clearSelection() {
      document.querySelectorAll('tr.selected-row').forEach((tr) => {
        tr.classList.remove('selected-row');
      });
      rowIdToMarker.forEach((marker) => {
        marker.setZIndexOffset(0);
      });
      selectedRowId = null;
    }

    function selectRowAndMarker(rowId) {
      if (!rowId) return;
      clearSelection();
      selectedRowId = rowId;

      const rowEl = document.querySelector(`tr[data-row-id="${rowId}"]`);
      if (rowEl) {
        rowEl.classList.add('selected-row');
        rowEl.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }

      const marker = rowIdToMarker.get(rowId);
      if (marker && map) {
        marker.setZIndexOffset(1000);
        const coords = marker.getLatLng();
        map.setView(coords, 13, { animate: true });
        marker.openPopup();
      }
    }

    // --- Table rendering ------------------------------------------------------

    function renderTableHeader() {
      const headerRow = document.getElementById('table-header-row');
      headerRow.innerHTML = '';

      COLUMN_CONFIG.forEach((col) => {
        const th = document.createElement('th');
        th.textContent = col.label;
        th.dataset.colKey = col.key;

        const indicator = document.createElement('span');
        indicator.className = 'sort-indicator';
        indicator.textContent = '';
        th.appendChild(indicator);

        th.addEventListener('click', () => {
          let direction = 'asc';
          if (currentSort.column === col.key && currentSort.direction === 'asc') {
            direction = 'desc';
          }
          currentSort = { column: col.key, direction };
          sortAndRender();
        });

        headerRow.appendChild(th);
      });

      updateSortIndicators();
    }

    function updateSortIndicators() {
      const headerCells = document.querySelectorAll('#table-header-row th');
      headerCells.forEach((th) => {
        const key = th.dataset.colKey;
        const indicator = th.querySelector('.sort-indicator');
        if (!indicator) return;
        if (currentSort.column === key) {
          indicator.textContent = currentSort.direction === 'asc' ? '▲' : '▼';
        } else {
          indicator.textContent = '';
        }
      });
    }

    function renderTableBody(rows) {
      const tbody = document.getElementById('table-body');
      tbody.innerHTML = '';

      rows.forEach((row) => {
        const tr = document.createElement('tr');
        const rowId = row.__id;
        tr.dataset.rowId = rowId;

        COLUMNS_TO_DISPLAY.forEach((key) => {
          const td = document.createElement('td');
          const value = row[key];

          if (key === 'link' && value) {
            const a = document.createElement('a');
            a.href = value;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            a.textContent = value;
            td.appendChild(a);
          } else if (key === 'bedrooms' || key === 'bathrooms' || key === 'sqFt') {
            td.textContent = value != null ? value : '';
          } else {
            td.textContent = value != null ? value : '';
          }

          tr.appendChild(td);
        });

        tr.addEventListener('click', () => {
          selectRowAndMarker(rowId);
        });

        tbody.appendChild(tr);
      });
    }

    function sortAndRender() {
      const { column, direction } = currentSort;
      let rowsToRender = [...allRows];

      if (column) {
        rowsToRender.sort((a, b) => compareRows(a, b, column, direction));
      }

      renderTableBody(rowsToRender);
      updateSortIndicators();
    }

    // --- Map rendering --------------------------------------------------------

    function initMap() {
      map = L.map('map');

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
    }

    function addMarkersFromRows(rows) {
      if (!map || !markersLayer) return;

      markersLayer.clearLayers();
      rowIdToMarker.clear();

      const bounds = [];

      rows.forEach((row) => {
        const url = row.link;
        const coords = LINK_TO_COORDS[url];
        if (!coords) return; // skip rows we don't have approximate coords for

        const marker = L.marker([coords.lat, coords.lng]);

        const popupHtml = `
          <strong>${row.quickDescription ?? 'Listing'}</strong><br/>
          ${row.bedrooms != null || row.bathrooms != null ? `Beds/Baths: ${row.bedrooms ?? '?'} / ${row.bathrooms ?? '?'}<br/>` : ''}
          ${row.totalCost ? `Total cost: ${row.totalCost}<br/>` : ''}
          ${row.costPerCouple ? `Per couple: ${row.costPerCouple}<br/>` : ''}
          ${url ? `<a href="${url}" target="_blank" rel="noopener noreferrer">Open listing</a>` : ''}
        `;

        marker.bindPopup(popupHtml.trim());

        const rowId = row.__id;
        rowIdToMarker.set(rowId, marker);

        marker.on('click', () => {
          selectRowAndMarker(rowId);
        });

        marker.addTo(markersLayer);
        bounds.push([coords.lat, coords.lng]);
      });

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [30, 30] });
      } else {
        // Default to greater San Diego if something goes wrong
        map.setView([32.7157, -117.1611], 10);
      }
    }

    // --- JSON loading / initialization ---------------------------------------

    function loadData() {
      fetch(DATA_JSON_PATH)
        .then((resp) => {
          if (!resp.ok) {
            throw new Error(`Failed to load ${DATA_JSON_PATH}: ${resp.status}`);
          }
          return resp.json();
        })
        .then((data) => {
          if (!Array.isArray(data)) {
            console.error('Unexpected JSON format');
            return;
          }

          // Attach stable IDs
          data.forEach((row, index) => {
            row.__id = String(index + 1);
          });

          allRows = data;
          renderTableHeader();
          sortAndRender();
          addMarkersFromRows(allRows);
        })
        .catch((err) => {
          console.error('Error loading JSON data', err);
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      loadData();
    });
  </script>
</body>
</html>
